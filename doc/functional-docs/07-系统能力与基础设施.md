# 系统能力与基础设施

本模块描述后端横切能力与基础设施配置。

## 1. 安全与鉴权

- Spring Security + JWT。
- `JwtAuthenticationFilter` 解析 Token 并写入 `SecurityContext` 与 `UserContext`。
- 公开放行：
  - `/api/v1/users/login`、`/api/v1/users/register`
  - `/api/v1/captcha`
  - `/api/v1/admin/login`
  - `GET /api/v1/recipes/**`
  - `GET /api/v1/interactions/comments/**`
  - `/ws`、Swagger 相关路径
- 管理后台：`/api/v1/admin/**` 仅允许 `admin` 角色。

## 2. Redis 与缓存

- Redis 作为缓存与限流/幂等/黑名单存储。
- 缓存域：分类、仪表盘、用户、菜谱详情（可扩展）。
- 序列化：Jackson + JavaTimeModule。

## 3. 限流与幂等

- 限流注解：`@RateLimit`，支持 IP/USER/GLOBAL 维度。
- 幂等注解：`@Idempotent`，依赖 `X-Idempotent-Token`。
- 获取幂等 Token：`GET /api/v1/common/idempotent/token`（Redis 保存 5 分钟）。

## 4. 文件上传（COS）

- 接口：`POST /api/v1/common/upload`。
- 依赖腾讯云 COS：`COS_SECRET_ID` / `COS_SECRET_KEY` / `COS_REGION` / `COS_BUCKET_NAME`。
- 返回：可访问的公网 URL。
- 上传限制：单文件与总请求 50MB。

## 5. WebSocket 与通知

- 端点：`/ws?token=...`（Token 作为查询参数）。
- 在线状态：Redis 保存心跳，60 秒无心跳视为离线。
- 通知类型：审核结果、私信、关注、评论回复/点赞等。
- 强制下线：发送 `FORCED_LOGOUT` 消息并关闭会话。

## 6. 定时任务

- 热门菜谱缓存预热：每 5 分钟执行，默认预热 20 条。

## 7. 全局异常与统一返回

- 统一返回结构：`{ code, msg, data }`。
- 参数校验、权限不足、文件过大、404 等统一处理。
- 日志输出会过滤常见敏感参数。

## 8. 配置与运行要点

- 核心配置文件：`recipe-platform/recipe-web/src/main/resources/application.yml`。
- 依赖环境变量：数据库、Redis、JWT、COS 等。
- `Dotenv` 启动时读取 `.env` 并写入系统属性。
