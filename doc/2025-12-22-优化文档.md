# 2025-12-22 优化文档

本次优化围绕性能、可靠性、安全性、可维护性与可观测性进行集中改进，覆盖后端核心业务、管理端与社交模块的关键路径。

## 一、优化范围与目标

- 降低高频接口的数据库往返与内存压力（消除 N+1、避免全量加载）。
- 提升并发一致性（事务、原子更新、幂等处理）。
- 修复历史遗留的状态语义反转与魔术数字。
- 强化输入校验与 DTO 隔离，避免过度绑定。
- 增强日志与故障可观测性。
- 拆分单体服务类，降低耦合与维护成本。

## 二、性能优化

1) 会话列表与聊天分页  
- 新增“会话最新消息”查询，数据库侧聚合，避免全量加载。  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/mapper/ChatMessageMapper.java`  
- `listConversations` 改为：最新消息查询 + 未读数聚合 + 批量用户查询。  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/SocialServiceImpl.java`  
- `pageMessages` 发送者信息批量加载，避免逐条查询。  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/SocialServiceImpl.java`

2) 关注列表  
- 关注列表改为联表分页，一次 SQL 获取关注用户信息。  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/mapper/UserFollowMapper.java`  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/SocialServiceImpl.java`

3) 收藏列表  
- 收藏列表改为批量查询菜谱与作者，避免 `1+N+N` 查询。  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/InteractionServiceImpl.java`

4) 后台管理 N+1 清理  
- 用户列表、评论列表、菜谱详情分页、仪表盘热点用户与最新动态均批量加载。  
  文件：  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminUserServiceImpl.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminCommentServiceImpl.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminRecipeServiceImpl.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminDashboardServiceImpl.java`

5) 分类映射  
- 分类 ID -> 名称改为缓存查询，移除硬编码映射。  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/CategoryServiceImpl.java`  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/RecipeServiceImpl.java`

## 三、并发一致性与事务

- `toggleCommentLike` 引入事务与原子自增/自减，处理重复点赞幂等。  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/InteractionServiceImpl.java`
- 浏览量更新改为原子 SQL 更新，避免并发丢失。  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/RecipeServiceImpl.java`
- 多表删除统一加事务：  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/RecipeServiceImpl.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/InteractionServiceImpl.java`

## 四、安全与认证

- 登录逻辑重构：`login` 与 `forceLogin` 复用校验流程，避免重复与不一致。  
  文件：`recipe-platform/recipe-system/src/main/java/com/n1etzsch3/recipe/system/service/impl/AuthServiceImpl.java`
- 增加登录失败次数限制与锁定逻辑，统一错误信息，降低枚举风险。  
  文件：`recipe-platform/recipe-system/src/main/java/com/n1etzsch3/recipe/system/service/impl/AuthServiceImpl.java`
- JWT 密钥移除硬编码，强制从 `JWT_SECRET` 读取并校验长度。  
  文件：`recipe-platform/recipe-common/src/main/java/com/n1etzsch3/recipe/common/utils/JwtUtils.java`  
  文档：`doc/functional-docs/10-运维与部署.md`

## 五、可维护性与结构优化

- 管理端服务拆分：从单一 `AdminServiceImpl` 拆分为独立职责服务（Auth/Dashboard/Recipe/Category/User/Comment）。  
  文件：  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminServiceImpl.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminAuthServiceImpl.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminDashboardServiceImpl.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminRecipeServiceImpl.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminCategoryServiceImpl.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminUserServiceImpl.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminCommentServiceImpl.java`
- 创建/更新菜谱的 DTO 映射抽取为单方法，减少重复代码。  
  文件：`recipe-platform/recipe-web/src/main/java/com/n1etzsch3/recipe/web/controller/RecipeController.java`

## 六、输入校验与 DTO 化

- Admin 接口引入 DTO 与 `@Valid` 校验，移除 `Map`/实体直接接参：  
  文件：`recipe-platform/recipe-web/src/main/java/com/n1etzsch3/recipe/web/controller/AdminController.java`  
  新增 DTO：  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/domain/dto/AdminUserCreateDTO.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/domain/dto/AdminUserUpdateDTO.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/domain/dto/AdminCategoryDTO.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/domain/dto/AdminBatchAuditDTO.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/domain/dto/AdminRecipeBatchStatusDTO.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/domain/dto/AdminUserBatchStatusDTO.java`
- `UserStatusDTO` 增加校验与状态含义修正。  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/domain/dto/UserStatusDTO.java`

## 七、魔术数字与历史状态反转修复

- 管理员通知中用户状态判断改为 `UserConstants.NORMAL`，避免“0/1 语义反转”。  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/NotificationServiceImpl.java`
- 用户状态操作日志与批量状态更新修正为 `UserConstants.DISABLE` 判断。  
  文件：`recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminUserServiceImpl.java`

## 八、可观测性改进

- 通知失败与 Token 解析失败补充日志，避免吞异常：  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/InteractionServiceImpl.java`  
  `recipe-platform/recipe-web/src/main/java/com/n1etzsch3/recipe/web/controller/AuthController.java`  
  `recipe-platform/recipe-business/src/main/java/com/n1etzsch3/recipe/business/service/impl/AdminLogServiceImpl.java`

## 九、影响与提升总结

- **性能**：高频列表接口与会话接口显著减少 SQL 次数，避免全量加载导致的内存与延迟问题。  
- **一致性**：关键写操作具备事务保护，计数更新采用原子 SQL，减少并发数据错乱。  
- **安全性**：登录过程防枚举与暴力破解能力增强，JWT 密钥强制配置。  
- **可维护性**：管理端服务职责拆分、DTO 化接参，代码结构更清晰可扩展。  
- **可观测性**：异常不再被吞，日志覆盖关键失败路径，便于排障与监控。

## 十、后续建议

- 为 `sys_message` 等高频表添加复合索引（sender/receiver/create_time）以配合会话聚合查询。  
- 为 Admin DTO 接口补充接口级回归用例。  
- 将更多批量操作改为 SQL 层批量更新，进一步降低 DB 往返。
